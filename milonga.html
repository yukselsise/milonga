import Foundation

// MARK: - Milonga Model
struct MilongaResponse: Codable {
    let milongalar: [Milonga]
    let sonGuncelleme: String
}

struct Milonga: Codable, Identifiable {
    let id: Int
    let ad: String
    let sehir: String
    let semt: String
    let adres: String
    let gun: String
    let saat: String
    let bitisSaat: String
    let ucret: String
    let telefon: String
    let email: String?
    let website: String?
    let aciklama: String
    let aktif: Bool
    let resim: String?
}

// MARK: - Network Service
class MilongaService: ObservableObject {
    @Published var milongalar: [Milonga] = []
    @Published var isLoading = false
    @Published var errorMessage: String?
    
    private let baseURL = "https://yukselsise.github.io/milonga" // GitHub Pages URL'iniz
    
    func fetchMilongalar() {
        isLoading = true
        errorMessage = nil
        
        guard let url = URL(string: "\(baseURL)/milongalar.json") else {
            errorMessage = "Geçersiz URL"
            isLoading = false
            return
        }
        
        URLSession.shared.dataTask(with: url) { [weak self] data, response, error in
            DispatchQueue.main.async {
                self?.isLoading = false
                
                if let error = error {
                    self?.errorMessage = "Ağ hatası: \(error.localizedDescription)"
                    return
                }
                
                guard let data = data else {
                    self?.errorMessage = "Veri alınamadı"
                    return
                }
                
                do {
                    let milongaResponse = try JSONDecoder().decode(MilongaResponse.self, from: data)
                    self?.milongalar = milongaResponse.milongalar.filter { $0.aktif }
                } catch {
                    self?.errorMessage = "Veri çözümlenemedi: \(error.localizedDescription)"
                }
            }
        }.resume()
    }
}

// MARK: - SwiftUI View Example
import SwiftUI

struct MilongaListView: View {
    @StateObject private var service = MilongaService()
    
    var body: some View {
        NavigationView {
            Group {
                if service.isLoading {
                    ProgressView("Yükleniyor...")
                } else if let errorMessage = service.errorMessage {
                    VStack {
                        Image(systemName: "exclamationmark.triangle")
                            .font(.largeTitle)
                            .foregroundColor(.red)
                        Text(errorMessage)
                            .multilineTextAlignment(.center)
                        Button("Tekrar Dene") {
                            service.fetchMilongalar()
                        }
                        .buttonStyle(.borderedProminent)
                    }
                    .padding()
                } else {
                    List(service.milongalar) { milonga in
                        MilongaRowView(milonga: milonga)
                    }
                }
            }
            .navigationTitle("Milongalar")
            .onAppear {
                service.fetchMilongalar()
            }
            .refreshable {
                service.fetchMilongalar()
            }
        }
    }
}

struct MilongaRowView: View {
    let milonga: Milonga
    
    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            HStack {
                Text(milonga.ad)
                    .font(.headline)
                    .foregroundColor(.primary)
                Spacer()
                Text(milonga.sehir)
                    .font(.caption)
                    .padding(.horizontal, 8)
                    .padding(.vertical, 4)
                    .background(Color.blue.opacity(0.2))
                    .cornerRadius(8)
            }
            
            HStack {
                Image(systemName: "calendar")
                    .foregroundColor(.secondary)
                Text(milonga.gun)
                    .font(.subheadline)
                
                Spacer()
                
                Image(systemName: "clock")
                    .foregroundColor(.secondary)
                Text("\(milonga.saat) - \(milonga.bitisSaat)")
                    .font(.subheadline)
            }
            
            HStack {
                Image(systemName: "location")
                    .foregroundColor(.secondary)
                Text(milonga.adres)
                    .font(.caption)
                    .foregroundColor(.secondary)
                    .lineLimit(2)
            }
            
            HStack {
                Image(systemName: "banknote")
                    .foregroundColor(.green)
                Text(milonga.ucret)
                    .font(.subheadline)
                    .fontWeight(.semibold)
                    .foregroundColor(.green)
                
                Spacer()
                
                Button(action: {
                    if let url = URL(string: "tel:\(milonga.telefon)") {
                        UIApplication.shared.open(url)
                    }
                }) {
                    Image(systemName: "phone.fill")
                        .foregroundColor(.blue)
                }
                .buttonStyle(.plain)
            }
        }
        .padding(.vertical, 4)
    }
}
